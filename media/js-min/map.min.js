//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/******************************************* LEADERBOARD YO **************************************///~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
//******************************** Map/pointer Stuff ********************************
var MapPoint=function(){if(arguments.callee._singletonInstance)return arguments.callee._singletonInstance;arguments.callee._singletonInstance=this};MapPoint.prototype=function(){function s(e){n.transitionClass("active",e)}function o(e){t.pulsate(60,130,.75,4,e)}var e,t,n,r,i=0;return{init:function(i){if(i){e=i.find(".point-wrapper");t=i.find(".point")}else{e=$(".leaderboard .point-wrapper");t=$(".leaderboard .point")}n=e.find(".line-container");r=e.find(".userCar");typeof info!="undefined"&&this.setPointerWeek(info.user.week);this.hidePointer()},setPointerWeek:function(t){i=t;e.addClass("week"+t);return this},updateUserCar:function(e){r.html(e);return this},hidePointer:function(){e.addClass("inactive");t.hide();return this},showPointer:function(t){this.hidePointer();setTimeout(function(){e.transitionClass("inactive",function(){o();s(function(){r.transitionClass("active")})})},t)}}}();var Leaderboard=function(){function b(e,t){var n=e.toString();n=(new Array(t.toString().length-n.length+1)).join("0").concat(n);return numberWithCommas(n)}function w(e){var t=parseInt(String(e).slice(-1));return e+(t>3?"th":t==1?"st":t==2?"nd":"rd")}function E(t){if(typeof i=="undefined"){if(typeof Dashboard=="function"){i=new Dashboard;i.updateUserRank(t)}}else i.updateUserRank(t);e.updateUserRank(t)}function S(e){if(e===null)return-1;if(typeof e.all=="undefined"||typeof e.rank=="undefined")return-1;var t={myRank:{},topLeaders:{},leadersById:{}};$.each(e.all,function(e,n){n.weekpoints===null&&(n.weekpoints=0);if(n.rank<=5){t.topLeaders[n.rank]={name:n.firstname+" "+n.lastname,image:getFacebookPictureUrl(n.fbid),points:n.weekpoints,rank:n.rank,id:n.fbid,duration:n.duration_week,place:{myRank:"",topLeaders:n.rank}};t.leadersById[n.fbid]=t.topLeaders[n.rank]}else t.leadersById[n.fbid]={rank:n.rank,place:{myRank:"",topLeaders:""}}});typeof e.personal!="undefined"&&$.each(e.personal,function(e,n){n.weekpoints===null&&(n.weekpoints=0);var r=e+1,i="";if(n.rank<=5){i=n.rank;t.topLeaders[n.rank].place.myRank=r}t.myRank[e+1]={name:n.firstname+" "+n.lastname,image:getFacebookPictureUrl(n.fbid),points:n.weekpoints,rank:n.rank,id:n.fbid,duration:n.duration_week,place:{myRank:r,topLeaders:i}};t.leadersById[n.fbid].place.myRank=r});return t}function x(e,r){n.lock=0;var i=200,s,o=(new Date).getTime();e||(e=h.data("week")?h.data("week"):info.user.week);$.ajax({url:"/api/nfs/leaderboard",type:"post",data:{week:e},success:function(e){if(typeof e.leaderboard!="undefined"){var n=S(e.leaderboard);if(typeof r=="function")r(n);else{var a=(new Date).getTime();s=a-o;setTimeout(function(){t.stop();u.fadeOut(300);typeof info!="undefined"&&E(n.leadersById[info.user.fbid].rank);A(n)},i-s<0?0:i-s)}}},error:function(e,t){}})}function T(e,t){var n=$(m[1][0].outerHTML);n.find(".name")[0].innerHTML=e.name.toUpperCase();n.find(".picture > img")[0].src=e.image;n.find(".points")[0].innerHTML=e.points;n.removeClass().addClass("leader "+t);y.prepend(n);return n}function N(e,t,r,i){var s=T(e,"active "+t);n.acquire();setTimeout(function(){s.transitionClass(r,function(){n.release()}).removeClass(t).removeClass("gotoplace_"+i);m[parseInt(i)]=s},0)}function C(e,t){n.acquire();e.transitionClass(t,function(){e.remove();n.release()}).removeClass(function(e,t){return(t.match(/\bplace_-\S+/g)||[]).join(" ")})}function k(e,t){g[t].text(e)}function L(e,t,n){typeof t=="undefined"&&(t=0);$({someValue:t}).animate({someValue:n},{duration:1500,easing:"swing",step:function(){e.text(b(Math.round(this.someValue),n))},complete:function(){e.text(b(n,n))}})}function A(e){var t=f.filter(".active");if(t.length===0||Object.keys(o).length===0){s.showPointer(1e3);o=e;_("myRank")}else t.hasClass("myRank")?D("myRank",e):t.hasClass("topLeaders")&&D("topLeaders",e)}function O(e,t,r,i){n.acquire();var s=info.ismobile?"leader-info":"middle";setTimeout(function(){e.on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(t){if(t.target.className==s){e.off("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");n.release()}});e.addClass("active");L(e.find(".points"),r,i)},t)}function M(){r.acquire(5);$.each(m,function(e,t){t.on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(e){$(this).off("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");setTimeout(function(){r.release()},100)});t.removeClass("active")})}function _(e){var t=f.filter(".active");if(!t.hasClass(e)){t.removeClass("active");f.filter("."+e).addClass("active")}r.setParams(e);m[1].hasClass("active")||r.lock>0?M():r.call()}function D(e,t){var r=$.extend({},m);$.each(t[e],function(i,s){var u=o.leadersById[s.id],a="gotoplace_%num% place_%num%".replace(/%num%/g,i);k(s.rank,i);if(typeof u=="undefined")N(s,"offscreen-bottom",a,i);else if(!u.place[e])N(s,u.rank<t[e][1].rank?"offscreen-top":"offscreen-bottom",a,i);else{if(u.place[e]!=i){n.acquire();r[u.place[e]].transitionClass(a,function(){n.release()}).removeClass("place_"+u.place[e]).removeClass("gotoplace_"+i);m[i]=r[u.place[e]]}var f=r[u.place[e]].find(".points"),l=f.html().replace(/,/g,"");L(f,l,s.points)}});$.each(o[e],function(n,i){t.leadersById[i.id].place[e]||C(r[n],t.leadersById[i.id].rank>t[e][1].rank?"offscreen-bottom":"offscreen-top")});o=t}function P(e){var t=200;$.each(o[e],function(e,t){e=parseInt(e);m[e].find(".name").text(t.name.toUpperCase());m[e].find(".picture > img").attr("src",t.image);g[e].text(t.rank)});for(var n=1;n<6;n++)if(typeof o[e][n]!="undefined"){var r=parseInt(o[e][n].points);O(m[n],(n-1)*t,0,r)}}function H(n){var i=f.filter(".active").hasClass("myRank")?"myRank":"topLeaders";r.acquire();u.show();t.spin(u[0]);x(n,function(e){o=e;t.stop();u.fadeOut(300);setTimeout(function(){r.release()},200)});_(i,n);e.setWeek(n)}if(arguments.callee._singletonInstance)return arguments.callee._singletonInstance;arguments.callee._singletonInstance=this;var e=this,t=new Spinner({color:"#ddd",shadow:!0,top:380,left:490}),n,r,i,s,o={},u,a,f,l,c,h,p,d,v,m={},g={},y;this.initialize=function(){i=new Dashboard;n=new Semaphore;r=new Semaphore(P);u=$("#leaderboard-overlay");a=$("#map-modal");h=$("#leaderboard-week-leaders");p=h.find("img.weeklyLeadersHeader");d=h.find("a.left-arrow");v=h.find("a.right-arrow");y=a.find(".leaders");f=a.find("ul.nav li");l=f.filter(".position").find(".box");c=f.filter(".week").find(".box");for(var t=1;t<6;t++){m[t]=y.find(".leader.place_"+t);g[t]=y.find(".leader_rank.place_"+t)}s=new MapPoint;s.init(a);this.setWeek(info.user.week);a.find(".close").click(function(){e.hideLeaderboard();return!1});f.filter(".myRank").find("a").click(function(){!$(this).parent().hasClass("active")&&n.call()&&_("myRank");return!1});f.filter(".topLeaders").find("a").click(function(){!$(this).parent().hasClass("active")&&n.call()&&_("topLeaders");return!1});a.find("a.recruit-drivers").on("click",function(){dash.shareApp("facebook");return!1});d.click(function(){h.data("week")!=1&&n.call()&&H(h.data("week")-1);return!1});v.click(function(){parseInt(h.data("week"))<parseInt(info.user.week)&&n.call()&&H(h.data("week")+1);return!1})};this.showLeaderboard=function(){u.show();t.spin(u[0]);showModal(a,x)};this.hideLeaderboard=function(){hideModal(a)};this.updateMapCar=function(e){s.updateUserCar(e)};this.updateUserRank=function(e){l.text(w(e))};this.setWeek=function(e){e=parseInt(e);h.data("week",e);p[0].src="/media/images/dashboard/leaderboard/week"+e+"leaders.png";c.text(e+"/6");e<parseInt(info.user.week)?v.removeClass("inactive"):v.addClass("inactive");e===1?d.addClass("inactive"):d.removeClass("inactive")}},leaderboard=new Leaderboard;if(typeof executeOnLoad=="undefined")var executeOnLoad=[];executeOnLoad.push(function(){leaderboard.initialize()});