var CarSelector=function(){function e(e){b.active=e?e:h.filter(".active:first"),b.next=b.active.nextOrFirst(".car",h).addClass("next"),b.prev=b.active.prevOrLast(".car",h).addClass("prev")}function t(e){O.active=e?e:x.filter(".active:first"),O.next=O.active.nextOrFirst(".car",x).addClass("next"),O.prev=O.active.prevOrLast(".car",x).addClass("prev"),O.nextnext=O.next.nextOrFirst(".car",x).addClass("nextnext"),O.prevprev=O.prev.prevOrLast(".car",x).addClass("prevprev")}function n(){p.addClass("carselect"),m.removeClass("active")}function a(){spinner.stop(),C.hide(function(){$(this).remove(),m.transitionClass("loaded",function(){setTimeout(function(){b.active.transitionClass("unloaded",function(){n()})},50)},"carselector-nav")});var e=$(".cars .car.active").attr("data-model");f.play(getSoundUrl(e))}function i(e){return"prev"==e?"next":"prev"}function r(n,a,i,r){n.on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(a){a.target==a.currentTarget&&(n.off("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd"),n.removeClass("inmotion"),r&&("undefined"!=typeof n.data("model")?(f.play(getSoundUrl(n.data("model"))),e(n)):t(n)),T.release())}),n.toggleClass(a+" inmotion "+i)}function s(e){T.acquire(2);var t=$.extend({},b);t[i(e)].removeClass(i(e)),r(t.active,i(e),"active"),r(t[e],"active",e,!0)}function o(e){T.acquire(4);var t=$.extend({},O);t[new Array(3).join(i(e))].removeClass(new Array(3).join(i(e))),r(t[i(e)],i(e),new Array(3).join(i(e))),r(t.active,i(e),"active"),r(t[e],"active",e,!0),r(t[new Array(3).join(e)],e,new Array(3).join(e))}function c(e){s(e),o(e)}function d(e,t){info.user.car=e.toString(),info.user.car_mods=t.toString(),"undefined"==typeof u&&"function"==typeof CarCustomizer&&(u=new CarCustomizer),u.setCarModel(e)}if(arguments.callee._singletonInstance)return arguments.callee._singletonInstance;arguments.callee._singletonInstance=this;var u,l,f,v,p,m,C,h,x,g,w,y,S=new Semaphore(a),T=new Semaphore,k=this,L=300,b={},O={};this.isActive=function(){return m.hasClass("in")},this.carImageLoaded=function(){S.release()&&S.unset()},this.initVariables=function(){u=new CarCustomizer,l=new Dashboard,v=new Leaderboard,f=new SoundPlayer,m=$("#carselect"),p=$("body"),C=$("#carselect-loader-overlay"),h=m.find(".cars .car"),x=m.find(".car-buttons .car"),g=m.find("a.left"),w=m.find("a.right"),y=m.find(".accept"),h.each(function(){f.add(getSoundUrl($(this).data("model")))}),h.filter(":nth-child(2)").addClass("active"),x.filter(":nth-child(2)").addClass("active"),e(),t(),"undefined"!=typeof carsLoaded&&(S.acquire(h.length-carsLoaded)?S.unset():spinner.spin(C[0]))},this.initEventListeners=function(){return g.click(function(){return k.addClickToQueue("prev"),!1}),w.click(function(){return k.addClickToQueue("next"),!1}),y.click(function(){return k.submitCar(),!1}),x.click(function(){$(this).hasClass("inmotion")||k.addClickToQueue($(this).hasClass("next")?"next":$(this).hasClass("prev")?"prev":"")}),"function"==typeof Hammer?(Hammer(m.find(".cars")[0]).on("swipeleft swiperight",function(e){setTimeout(function(){k.addClickToQueue("swipeleft"===e.type?"next":"prev")},50)}),!0):void m.find(".speaker").on("click",function(){var e=$(".cars .car.active").attr("data-model");f.play(getSoundUrl(e))})},this.addClickToQueue=function(e){T.call()&&e&&c(e)},this.submitCar=function(e){e||(e=b.active.data("model")),$.ajax({url:"/api/car/model",type:"post",data:{carmodel:e},success:function(t){"success"==t.status&&(d(e,t.car_mods),setTimeout(function(){k.hide()},300))},error:function(){}})},this.hide=function(){p.removeClass("carselect"),m.fadeOut(L,function(){$(this).remove(),l.showHowToPlay()})}},carSelector=new CarSelector;if("undefined"==typeof executeOnLoad)var executeOnLoad=[];executeOnLoad.push(function(){carSelector.initVariables(),carSelector.initEventListeners()});